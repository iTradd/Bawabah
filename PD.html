<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تفاصيل العقار</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap">
    <script src="script.js"></script> <!-- استيراد ملف apiUrl -->
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #F9FAFB;
            direction: rtl;
            margin: 0;
            padding: 0;
            color: #333;
        }

        header {
            background: linear-gradient(90deg, #F96E2A, #FB8C3E);
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 28px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .property-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            gap: 20px;
            flex-wrap: wrap;
        }

        .property-image {
            flex: 1;
            max-width: 400px;
            text-align: center;
        }

        .property-image {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    max-width: 400px;
}

.attachments {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
    justify-content: center;
}

.attachment-image {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 5px;
    border: 1px solid #ddd;
    transition: transform 0.3s ease;
}

.attachment-image:hover {
    transform: scale(1.1);
    border-color: #F96E2A;
}

.property-container {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 20px;
    padding: 20px;
}
        .property-image img {
            width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .property-details {
            flex: 2;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .property-details h1 {
            color: #F96E2A;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .property-details p {
            font-size: 16px;
            margin: 5px 0;
            color: #555;
        }

        .property-details p strong {
            color: #141414;
        }

        .property-details a {
            color: #007BFF;
            text-decoration: none;
            font-weight: bold;
        }

        .property-details a:hover {
            text-decoration: underline;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .action-buttons button {
            background-color: #F96E2A;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .action-buttons button:hover {
            background-color: #141414;
            transform: scale(1.05);
        }

.form-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

label {
    font-size: 14px;
    font-weight: bold;
}

input,
textarea,
select {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 14px;
    width: 100%;
    box-sizing: border-box;
}

textarea {
    resize: none;
    height: 80px;
}

button {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    background: #F96E2A;
    color: white;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s ease, transform 0.2s ease;
}

button:hover {
    background: #FB8C3E;
    transform: scale(1.05);
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    justify-content: center;
    align-items: center;
    background-color: rgba(0, 0, 0, 0.8); /* لون خلفية شفافة */
    z-index: 1000;
    overflow-y: auto; /* تمكين التمرير عند زيادة المحتوى */
    padding: 20px; /* مسافة لتجنب لصق المحتوى بحواف الشاشة */
    box-sizing: border-box;
}

.modal-content {
    background: white;
    width: 90%;
    max-width: 600px;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); /* ظل خفيف */
    display: flex;
    flex-direction: column;
    gap: 20px; /* مسافة بين العناصر داخل المحتوى */
    position: relative;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #ddd;
    padding-bottom: 10px;
    margin-bottom: 15px; /* مسافة أسفل العنوان */
}

.modal-header h2 {
    margin: 0;
    font-size: 20px;
    color: #333; /* لون النص */
}

.close-button {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #F96E2A; /* لون الزر */
    font-weight: bold;
}

.modal-body {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.form-group label {
    font-size: 14px;
    font-weight: bold;
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

textarea {
    resize: none; /* منع تغيير حجم الحقول النصية */
}

.save-button {
    background-color: #F96E2A; /* لون الزر */
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    align-self: flex-end; /* جعل الزر في الجانب الأيمن */
}

.save-button:hover {
    background-color: #FB8C3E; /* لون عند التمرير */
    transform: scale(1.05);
}
#imageModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    justify-content: center;
    align-items: flex-start; /* الصور تبدأ من الأعلى */
    background-color: rgba(0, 0, 0, 0.8); /* خلفية شفافة داكنة */
    z-index: 1000;
    overflow-y: auto; /* تمكين التمرير عند وجود العديد من الصور */
    padding: 20px;
    box-sizing: border-box;
}

#imageModal .modal-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    width: 100%;
    max-width: 80%;
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    margin-top: 20px; /* مسافة من الأعلى */
}

.modal-image {
    max-width: 100%;
    max-height: 80vh;
    margin: 10px 0;
    border-radius: 5px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); /* تأثير خفيف */
}

#imageModal .close-button {
    align-self: flex-start; /* الزر في الأعلى الأيسر */
    background-color: #F96E2A;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
    margin-bottom: 10px; /* مسافة تحت الزر */
}

#imageModal .close-button:hover {
    background-color: #FB8C3E; /* تغيير اللون عند التمرير */
}

        
.property-image img:hover {
    transform: scale(1.1); /* نفس التأثير المستخدم للمرفقات */
    border: 2px solid #F96E2A;
    transition: transform 0.3s ease, border 0.3s ease;
}

    
    </style>
</head>
<body>
    <header>تفاصيل العقار</header>
    <div class="property-container" id="propertyDetails">
        <!-- سيتم عرض تفاصيل العقار هنا -->
    </div>


    <script>

    function fetchPropertyDetails(propertyId) {
    console.log('Fetching property details for ID:', propertyId);
    fetch(`${apiUrl}?action=getPropertyDetails&sheet=Real_Estate&propertyId=${propertyId}`)
        .then(response => {
            console.log('Response received:', response);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(property => {
            console.log('Property details (Raw):', property);
if (!property || Object.keys(property).length === 0) {
    console.error('Property details are empty or undefined:', property);
    alert('تعذر العثور على تفاصيل العقار.');
    return;
}
            renderPropertyDetails(property);
        })
        .catch(error => {
            console.error('Error fetching property details:', error);
            document.getElementById('propertyDetails').innerHTML = '<p>حدث خطأ أثناء جلب البيانات.</p>';
        });
}



function renderPropertyDetails(property) {
    const container = document.getElementById('propertyDetails');
    container.innerHTML = `
        <div class="property-image">
            <img src="${property.صورة_العرض || 'images/default-image.jpg'}" 
     alt="${property.اسم_العقار}" 
     onclick="openModal('${property.صورة_العرض}', '${property.المرفقات || ''}')">
            <div class="attachments">
                ${property.المرفقات ? renderAttachments(property.المرفقات) : '<p>لا توجد مرفقات</p>'}
            </div>
        </div>
        <div class="property-details">
            <h1>${property.اسم_العقار}</h1>
            <p><strong>رقم الإعلان:</strong> ${property.معرف_العقار}</p>
            <p><strong>نوع العقار:</strong> ${property.نوع_العقار}</p>
            <p><strong>السعر:</strong> ${property.السعر || 'غير متوفر'} ريال</p>
            <p><strong>اسم المالك:</strong> ${property.اسم_المالك || 'غير متوفر'}</p>
            <p><strong>جوال المالك:</strong> ${property.جوال_المالك || 'غير متوفر'}</p>
            <p><strong>الموقع:</strong> ${property.الموقع}</p>
            <p><a href="${property.رابط_الموقع}" target="_blank">عرض على الخريطة</a></p>
            <p><strong>الوصف:</strong> ${property.الوصف}</p>
            <p><strong>المساحة:</strong> ${property.المساحة || 'غير متوفر'} م²</p>
            <p><strong>عرض الشارع:</strong> ${property.عرض_الشارع || 'غير متوفر'} متر</p>
            <p><strong>الواجهة:</strong> ${property.الواجهة || 'غير متوفر'}</p>
            <p><strong>الحالة:</strong> ${property.الحالة || 'غير متوفر'}</p>
            ${generateDynamicDetails(property)}
            <div class="action-buttons">
                <button onclick="editProperty(${property.معرف_العقار})">تعديل</button>
                <button onclick="deleteProperty('${property.معرف_العقار}')">حذف</button>
                <button onclick="archiveProperty(${property.معرف_العقار})">أرشفة</button>
            </div>
        </div>
    `;
}

function renderAttachments(attachments) {
    return attachments
        .split(',') // assuming attachments are comma-separated
        .map(
            (attachment, index) =>
                `<img src="${attachment}" alt="مرفق ${index + 1}" class="attachment-image" onclick="openModal('${attachment}', '${attachments}')">`
        )
        .join('');
}


function openModal(coverImage, attachments) {
    const modal = document.getElementById('imageModal');
    const modalContent = document.getElementById('modalContent');

    // مسح محتوى النافذة السابق
    modalContent.innerHTML = '';

    // إضافة صورة العرض في الأعلى إذا لم تكن ضمن المرفقات
    if (coverImage) {
        const cover = document.createElement('img');
        cover.src = coverImage;
        cover.className = 'modal-image';
        modalContent.appendChild(cover);
    }

    // عرض المرفقات أسفل صورة العرض
    if (attachments) {
        const uniqueAttachments = new Set(attachments.split(',')); // تجنب التكرار
        uniqueAttachments.forEach(attachment => {
            // تجاهل صورة العرض إذا كانت موجودة في المرفقات
            if (attachment !== coverImage) {
                const img = document.createElement('img');
                img.src = attachment;
                img.className = 'modal-image';
                modalContent.appendChild(img);
            }
        });
    }

    modal.style.display = 'flex'; // إظهار النافذة
}


function closeModal() {
    const modal = document.getElementById('imageModal');
    modal.style.display = 'none'; // Hide modal
}

function generateDynamicDetails(property) {
    if (property.نوع_العقار === 'فلة' || property.نوع_العقار === 'شقة' || property.نوع_العقار === 'دور' || property.نوع_العقار === 'شاليه') {
        return `
            <p><strong>عدد الغرف:</strong> ${property.عدد_الغرف || 'غير متوفر'}</p>
            <p><strong>عدد الحمامات:</strong> ${property.عدد_الحمامات || 'غير متوفر'}</p>
        `;
    } else if (property.نوع_العقار === 'أرض' || property.نوع_العقار === 'مزرعة') {
        return `
            <p><strong>استخدام العقار:</strong> ${property.استخدام_العقار || 'غير متوفر'}</p>
            <p><strong>عدد الشوارع المحيطة:</strong> ${property.عدد_الشوارع_المحيطة || 'غير متوفر'}</p>
        `;
    } else if (property.نوع_العقار === 'محل') {
        return `
            <p><strong>مساحة المحل:</strong> ${property.مساحة_المحل || 'غير متوفر'} م²</p>
            <p><strong>عدد الفتحات:</strong> ${property.عدد_الفتحات || 'غير متوفر'}</p>
        `;
    }
    return '';
}


 let currentProperty = null; // تعريف المتغير على مستوى الكود

function editProperty(propertyId) {
fetch(`${apiUrl}?action=getPropertyDetails&sheet=Real_Estate&propertyId=${propertyId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch property details');
            }
            return response.json();
        })
        .then(property => {
            currentProperty = property; // تحديث المتغير ببيانات العقار الحالية

            // تعبئة الحقول في النموذج
            document.getElementById('editName').value = property.اسم_العقار || '';
            document.getElementById('editType').value = property.نوع_العقار || '';
    document.getElementById('editPrice').value = property.السعر || '';
document.getElementById('editOwnerName').value = property.اسم_المالك || '';
document.getElementById('editOwnerPhone').value = property.جوال_المالك || '';
document.getElementById('editArea').value = property.المساحة || '';        
    document.getElementById('editLocation').value = property.الموقع || '';
            document.getElementById('editMapLink').value = property.رابط_الموقع || '';
            document.getElementById('editDescription').value = property.الوصف || '';
            document.getElementById('editStreetWidth').value = property.عرض_الشارع || '';
            document.getElementById('editFacade').value = property.الواجهة || '';

            // تحديث الحقول الديناميكية بناءً على نوع العقار
            updateFieldsBasedOnType(property.نوع_العقار);

            if (['شقة', 'فلة', 'دور', 'شاليه'].includes(property.نوع_العقار)) {
                document.getElementById('editRooms').value = property.عدد_الغرف || 0;
                document.getElementById('editBathrooms').value = property.عدد_الحمامات || 0;
            } else if (['أرض', 'مزرعة'].includes(property.نوع_العقار)) {
                document.getElementById('editUsage').value = property.استخدام_العقار || '';
                document.getElementById('editStreets').value = property.عدد_الشوارع_المحيطة || 0;
            } else if (property.نوع_العقار === 'محل') {
                document.getElementById('editArea').value = property.مساحة_المحل || 0;
                document.getElementById('editOpenings').value = property.عدد_الفتحات || 0;
            }

            // عرض نافذة التعديل
            document.getElementById('editModal').style.display = 'block';
        })
        .catch(error => {
            console.error('Error fetching property details:', error);
            alert('حدث خطأ أثناء جلب بيانات العقار.');
        });
}

        function updateFieldsBasedOnType() {
    const type = document.getElementById('editType').value;
    const dynamicFields = document.getElementById('dynamicFields');
    dynamicFields.innerHTML = ''; // مسح الحقول الحالية

    if (['شقة', 'فلة', 'دور', 'شاليه'].includes(type)) {
        dynamicFields.innerHTML = `
            <label>عدد الغرف:</label>
            <input type="number" id="editRooms" min="0">
            <label>عدد الحمامات:</label>
            <input type="number" id="editBathrooms" min="0">
        `;
    } else if (['أرض', 'مزرعة'].includes(type)) {
        dynamicFields.innerHTML = `
            <label>استخدام العقار:</label>
            <input type="text" id="editUsage">
            <label>عدد الشوارع المحيطة:</label>
            <input type="number" id="editStreets" min="0">
        `;
    } else if (type === 'محل') {
        dynamicFields.innerHTML = `
            <label>مساحة المحل:</label>
            <input type="number" id="editArea" min="0">
            <label>عدد الفتحات:</label>
            <input type="number" id="editOpenings" min="0">
        `;
    }
}

function saveChanges() {
    if (!currentProperty) {
        alert('لم يتم تحميل بيانات العقار بشكل صحيح.');
        return;
    }

    // إعداد بيانات العقار المعدلة
    const updatedProperty = {
        action: 'updateProperty', // تحديد الإجراء
        sheet: 'Real_Estate', // اسم الورقة
        معرف_العقار: currentProperty.معرف_العقار, // معرف العقار
        اسم_العقار: document.getElementById('editName').value,
        نوع_العقار: document.getElementById('editType').value,
        السعر: document.getElementById('editPrice').value,
        اسم_المالك: document.getElementById('editOwnerName').value,
        جوال_المالك: document.getElementById('editOwnerPhone').value,
        المساحة: document.getElementById('editArea').value,
        الموقع: document.getElementById('editLocation').value,
        رابط_الموقع: document.getElementById('editMapLink').value,
        الوصف: document.getElementById('editDescription').value,
        عرض_الشارع: document.getElementById('editStreetWidth').value,
        الواجهة: document.getElementById('editFacade').value,
    };

    // إضافة الحقول الديناميكية بناءً على نوع العقار
    const type = updatedProperty.نوع_العقار;

    if (['شقة', 'فلة', 'دور', 'شاليه'].includes(type)) {
        updatedProperty.عدد_الغرف = document.getElementById('editRooms').value;
        updatedProperty.عدد_الحمامات = document.getElementById('editBathrooms').value;
    } else if (['أرض', 'مزرعة'].includes(type)) {
        updatedProperty.استخدام_العقار = document.getElementById('editUsage').value;
        updatedProperty.عدد_الشوارع_المحيطة = document.getElementById('editStreets').value;
    } else if (type === 'محل') {
        updatedProperty.مساحة_المحل = document.getElementById('editArea').value;
        updatedProperty.عدد_الفتحات = document.getElementById('editOpenings').value;
    }

    console.log("Data to send:", updatedProperty); // تسجيل البيانات لإجراء التحقق

    // إرسال البيانات إلى Google Apps Script عبر Cloudflare Worker
    fetch(`${apiUrl}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedProperty),
    })
        .then(response => {
            console.log('Server Response:', response); // تسجيل استجابة الخادم
            if (!response.ok) {
                throw new Error('Failed to update property');
            }
            return response.json(); // توقع أن الاستجابة بصيغة JSON
        })
        .then(result => {
            if (result.status === 'success') {
                alert('تم حفظ التعديلات بنجاح');
               window.location.href = 'index.html'; // إعادة التوجيه للصفحة الرئيسية
             fetchPropertyDetails(currentProperty.معرف_العقار); // إعادة تحميل تفاصيل العقار
            } else {
                throw new Error(result.message || 'Unknown error');
            }
        })
        .catch(error => {
            console.error('Error saving changes:', error); // تسجيل تفاصيل الخطأ
            alert('حدث خطأ أثناء حفظ التعديلات.');
        });
}


function closeEditModal() {
    const editModal = document.getElementById('editModal');
    editModal.style.display = 'none';
}

        function closeImageModal() {
    const imageModal = document.getElementById('imageModal');
    imageModal.style.display = 'none';
}


        
        
function deleteProperty(propertyId) {
    if (confirm("هل أنت متأكد من حذف هذا العقار؟")) {
        fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'deleteProperty',
                sheet: 'Real_Estate',
                propertyId: propertyId,
            }),
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                alert('تم حذف العقار بنجاح');
                window.location.href = 'index.html'; // إعادة تحميل الصفحة لتحديث البيانات
            } else {
                alert(`خطأ: ${result.message}`);
            }
        })
        .catch(error => {
            console.error('Error deleting property:', error);
            alert('حدث خطأ أثناء الحذف.');
        });
    }
}


function archiveProperty(propertyId) {
    if (confirm("هل أنت متأكد من أرشفة هذا العقار؟")) {
        fetch(`${apiUrl}`, { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'archiveProperty',
                sheet: 'Real_Estate',
                propertyId: propertyId
            })
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error('Failed to archive property');
            }
            return response.json();
        })
        .then(result => {
            console.log('Archive result:', result);
            if (result.status === 'success') {
                alert('تمت أرشفة العقار بنجاح');
                window.location.href = 'index.html'; // إعادة التوجيه للصفحة الرئيسية
            } else {
                throw new Error(result.message || 'Unknown error');
            }
        })
        .catch(error => {
            console.error('Archive failed with message:', error.message);
            alert(`حدث خطأ أثناء الأرشفة: ${error.message}`);
        });
    }
}


        const urlParams = new URLSearchParams(window.location.search);
const propertyId = urlParams.get('propertyId');
console.log('Property ID:', propertyId); // تحقق مما إذا كان معرّف العقار يظهر هنا
if (propertyId) {
    fetchPropertyDetails(propertyId);
} else {
    document.getElementById('propertyDetails').innerHTML = '<p>معرف العقار غير متوفر.</p>';
}
    </script>
<div class="modal" id="editModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>تعديل العقار</h2>
            <button onclick="closeEditModal()">إغلاق</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>اسم العقار:</label>
                <input type="text" id="editName">
            </div>
            <div class="form-group">
                <label>نوع العقار:</label>
                <select id="editType" onchange="updateFieldsBasedOnType()">
                    <option value="شقة">شقة</option>
                    <option value="فلة">فلة</option>
                    <option value="دور">دور</option>
                    <option value="شاليه">شاليه</option>
                    <option value="أرض">أرض</option>
                    <option value="مزرعة">مزرعة</option>
                    <option value="محل">محل</option>
                </select>
            </div>
            <div class="form-group">
    <label>السعر:</label>
    <input type="number" id="editPrice" min="0">
</div>
<div class="form-group">
    <label>اسم المالك:</label>
    <input type="text" id="editOwnerName">
</div>
<div class="form-group">
    <label>جوال المالك:</label>
    <input type="tel" id="editOwnerPhone">
</div>
<div class="form-group">
    <label>المساحة:</label>
    <input type="number" id="editArea" min="0">
</div>
            <div class="form-group">
                <label>الموقع:</label>
                <input type="text" id="editLocation">
            </div>
            <div class="form-group">
                <label>رابط الموقع على الخريطة:</label>
                <input type="text" id="editMapLink">
            </div>
            <div class="form-group">
                <label>الوصف:</label>
                <textarea id="editDescription"></textarea>
            </div>
            <div class="form-group">
                <label>عرض الشارع:</label>
                <input type="text" id="editStreetWidth">
            </div>
            <div class="form-group">
                <label>الواجهة:</label>
                <input type="text" id="editFacade">
            </div>
            <div id="dynamicFields" class="form-group">
                <!-- سيتم توليد الحقول الديناميكية هنا بناءً على نوع العقار -->
            </div>
            <div class="form-group">
                <label>المرفقات الحالية:</label>
                <div id="currentAttachments"></div>
            </div>
            <div class="form-group">
                <label>إضافة مرفقات جديدة:</label>
                <input type="file" id="newAttachments" multiple>
                <div id="uploadStatus"></div>
            </div>
        </div>
        <div class="form-group">
            <button onclick="saveChanges()">حفظ</button>
        </div>
    </div>
</div>
  <div id="imageModal" class="modal">
    <div class="modal-content" id="modalContent"></div>
<button class="close-button" onclick="closeImageModal()">إغلاق</button>
</div>

</body>
</html>